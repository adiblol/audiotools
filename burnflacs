#!/bin/bash

get_flac_tag() {
	metaflac --show-tag="$1" "$2" | sed -e 's/.*=//g'
}

sanitize_cdtext() {
	        echo -n "$1" | sed -e 'y/ąćęłńóśżźĄĆĘŁŃÓŚŻŹ/acelnoszzACELNOSZZ/' | sed -e "s/\"/''/g" | tr -c "a-zA-Z0-9 ~!@#$%^&*()+=[]{}|;:,./<>?'-" '_' | head -c 80
}

cdtext_sane() {
	echo "$1 \"$(sanitize_cdtext "$2")\""
}

selfname="`basename "$0"`"
tmpdir="`mktemp -d --tmpdir="$HOME" ".tmp.${selfname}.XXXX"`"

echo "Temporary directory: $tmpdir"

# convert args to \n-separated list
while [ "x$1" != "x" ]; do
	readlink -f "$1" >> "${tmpdir}/flaclist"
	shift
done

cd "$tmpdir"

xargs -d '\n' -a "${tmpdir}/flaclist" shntool cue -- > "${tmpdir}/notags.cue"
xargs -d '\n' -a "${tmpdir}/flaclist" shntool join -e -o wav -d "$tmpdir" --

cue="${tmpdir}/joined.cue"

echo "REM Generated by $selfname from audiotools package" >> "$cue"
echo "REM Visit https://github.com/adiblol/audiotools/ for more info." >> "$cue"
echo '' >> "$cue"

in_flac="$(head -n 1 "${tmpdir}/flaclist")"

if [ "$VA" == "1" ]; then
	album_artist="Various Artists"
fi
if [ "x$album_artist" == "x" ]; then
	album_artist="$(get_flac_tag 'album artist' "$in_flac")"
fi
if [ "x$album_artist" == "x" ]; then
	album_artist="$(get_flac_tag 'album_artist' "$in_flac")"
fi
if [ "x$album_artist" == "x" ]; then
	album_artist="$(get_flac_tag 'albumartist' "$in_flac")"
fi
if [ "x$album_artist" == "x" ]; then
	album_artist="$(get_flac_tag 'artist' "$in_flac")"
fi
if [ "x$album_artist" != "x" ]; then
	cdtext_sane PERFORMER "${album_artist}" >> "$cue"
fi


album_name="$(get_flac_tag 'album' "$in_flac")"
if [ "x$album_name" == "x" ]; then
	album_name="$(basename "`dirname "$in_flac"`")"
fi
if [ "x$album_name" != "x" ]; then
	cdtext_sane TITLE "$album_name" >> "$cue"
fi



echo "FILE \"joined.wav\" WAVE" >> "$cue"
echo '' >> "$cue"

trackn=1

cat "${tmpdir}/notags.cue" | sed -e 's/^ *INDEX [0-9]\{1,2\} \([0-9:]\+\)$/\1/; t; d' | while read ts; do
	tracknp=$trackn
	if [ $trackn -lt 10 ]; then
		tracknp=0$trackn
	fi

	in_flac="$(cat "${tmpdir}/flaclist" | head -n $trackn | tail -n 1)"

	echo "TRACK $tracknp AUDIO" >> "$cue"
	
	track_name="$(get_flac_tag 'title' "$in_flac")"
	if [ "x$track_name" != "x" ]; then
		cdtext_sane TITLE "$track_name" >> "$cue"
	fi

	artist="$(get_flac_tag 'artist' "$in_flac")"
	if [ "x$artist" == "x" ]; then
		artist="$album_artist"
	fi
	if [ "x$artist" != "x" ]; then
		cdtext_sane PERFORMER "$artist" >> "$cue"
	fi
	
	#album_year="$(get_flac_tag 'date' "$in_flac" | sed -e 's/-.*//g')"
	#if [ "x$album_year" == "x" ]; then
	#	album_year="$(get_flac_tag 'date' "$in_flac" | sed -e 's/-.*//g')"
	#fi
	#if [ "x$album_year" != "x" ]; then
	#	album_year=" ($(normalize_title "$album_year"))"
	#fi
	
	echo "INDEX 01 $ts" >> "$cue"
	echo '' >> "$cue"
	trackn=$[$trackn+1]
done

less "$cue"
echo -n "Write to CD? (y/n) :  "
read dowrite
if [ "$dowrite" != "y" ]; then
	echo "Aborted by user. Leaving temporary files in $tmpdir"
	exit 1
fi

while [ "$dowrite" == "y" ]; do
	cdrdao write -v 2 --device /dev/sr0 --driver generic-mmc-raw --eject --speed 40 ${cdrdao_flags} "${tmpdir}/joined.cue"
	echo -n "Burn another copy? (y/n) :  "
	read dowrite
done

echo "Cleaning up..."
rm -fr "$tmpdir"

cd -
